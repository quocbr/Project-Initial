using System.Collections;
using System.Collections.Generic;
using UnityEngine;

#if UNITY_EDITOR
using UnityEditor;
#endif

namespace quocbr.DataManager
{
    [CreateAssetMenu(fileName = "#SCRIPTNAME#", menuName = "Game/#SCRIPTNAME#", order = 1)]
    public class #SCRIPTNAME#Data : ScriptableObject
    {
        [SerializeField] private #SCRIPTNAME#Record[] data;

        private Dictionary<int, #SCRIPTNAME#Record> _dictData;
        
        public Dictionary<int, #SCRIPTNAME#Record> Data
        {
            get
            {
                if (_dictData == null)
                {
                    EnsureInitDict();
                }   

                return _dictData;
            }
        }

        #region MonoBehaviour Callbacks

        private void OnValidate()
        {
#if UNITY_EDITOR
         // Example optional policy: if recordId < 0, auto-assign by row
         bool changed = false;
         for (int i = 0; i < data.Length; i++)
         {
             var r = data[i];
             if (r == null) continue;
             if (r.recordId != i)
             {
                 r.recordId = i;
                 changed = true;
             }
         }
         if (changed) 
         {
            EditorUtility.SetDirty(this);
            _dictData = null; // force rebuild after edits   
         }
#endif
        }

        #endregion

        #region Private Methods
        
        private void EnsureInitDict()
        {
            if (_dictData != null) return;
            InitDict();
        }
        
        private void InitDict()
        {
            if (data == null || data.Length == 0)
            {
                _dictData = new Dictionary<int, #SCRIPTNAME#Record>(0);
                return;
            }
        
            _dictData = new Dictionary<int, #SCRIPTNAME#Record>(data?.Length ?? 0);
            if (_dictData == null) return;
            foreach (var r in data)
            {
                if (r == null) continue;
                _dictData[r.recordId] = r; // last one wins if duplicates
            }
        }
        
        #endregion

        #region Public Methods
        
         public #SCRIPTNAME#Record GetRecord(int recordId)
        {
            EnsureInitDict();
            return _dictData.GetValueOrDefault(recordId);
        }
        
        #endregion
    }

    [System.Serializable]
    public class #SCRIPTNAME#Record
    {
        [HelpBox("auto-assigned id", HelpBoxMessageType.Info)]
        public int recordId;
    }
}